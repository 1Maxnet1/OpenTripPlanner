trigger: none
pool: TJP

schedules:
# We want to deploy automatically every night because of NeTExchanges
# and because we want to get rid of old realtime messages to match other environments
# Run every night 02:00, UTC time
- cron: "0 2 * * *"
  displayName: "Daily Night Run"
  branches:
    include:
    - resesok-otp2
  # Schedule even if there are no changes in the code
  always: true

resources:
  repositories:
  - repository: self
  - repository: Common
    type: git
    name: Infra/common-devops-templates
    ref: refs/tags/3.1.1

steps:
- task: AzureKeyVault@1
  displayName: 'Get deployment secrets'
  inputs:
    azureSubscription: 'ST IKT DEV'
    KeyVaultName: TJP-INFRA-KV-DEV
    SecretsFilter: >-
      ResResesokProxyClientId,
      ResResesokProxyResourceId,

- template: as-a-service/deploy.yaml@Common
  parameters:
    namespace: otp
    environment: PR
    azureSubscription: 'ST IKT DEV'
    deployments:
    - name: resesok-otp
      chart: otp
      version: latest
      timeout: 30m0s
      uninstallFirst: true
      values: docker-build/helm/otp/values/PR.yaml
      override:
      - OtpKeyVaultName=RES-RESP-KV-DEV
      - manageIdentity.clientId=$(ResResesokProxyClientId)
      - manageIdentity.resourceId=$(ResResesokProxyResourceId)
